name: Test

on: 
 push:

env:
  ANSIBLE_VERBOSITY: 2
  FROM_IMAGE_ARG: devshop/server:latest

jobs:
  test:
    name: Test DevShop

    runs-on: ubuntu-18.04
    steps:

    - uses: actions/checkout@v1
    - name: Get Composer Cache Directory
      id: composer-cache
      run: |
        echo "::set-output name=dir::$(composer config cache-files-dir)"

    - uses: actions/cache@v1
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-

    - name: Install Composer dependencies
      run: composer install --prefer-dist --no-progress --no-suggest

    - name: Launch pre-built DevShop Server Image devshop/server
      run: |
        bin/robo up "sleep infinity" \
          --follow 0

    - name: Install DevShop
      env:
        ANSIBLE_TAGS: "runtime"
        ANSIBLE_SKIP_TAGS: "none"
      # @TODO: Seems like env above is not making it's way to the container and devshop-ansible-playbook command: https://github.com/opendevshop/devshop/pull/487/checks?check_run_id=400001612#step:7:10
      # Once the problem is discovered, remove either 'env' or the --env options below.
      run: |
        docker-compose exec -T \
          --env ANSIBLE_TAGS=runtime \
          --env ANSIBLE_SKIP_TAGS=none \
            devshop \
            devshop-ansible-playbook

    - name: Test DevShop
      run: |
        bin/robo test --compose-file docker-compose-tests.yml

    - uses: actions/upload-artifact@v1
      if: failure()
      with:
        name: test-assets
        path: ./.github/test-assets
