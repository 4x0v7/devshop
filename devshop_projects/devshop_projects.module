<?php

/**
 * @file devshop_projects.module
 *
 * Provides Node Type, UI, and tools for DevShop Projects.
 */

include_once('inc/forms.inc');
include_once('inc/nodes.inc');
include_once('inc/tasks.inc');

// Lets keep front end code here.
include_once('inc/ui.inc');

/**
 * Implementation of hook_perm()
 *
 * Since we have a node type, "create project content permission is
 * automatically added by Drupal
 */
function devshop_projects_perm() {
  return array(
    'view projects',
    'delete project'
  );
}

/**
 * Implementation of hook_menu()
 */
function devshop_projects_menu() {

  $items['hosting/projects'] = array(
    'title' => 'Projects',
    'description' => 'Display a list of all projects',
    'page callback' => 'devshop_projects_projects_view',
    'access arguments' => array('view projects'),
    'menu_name' => 'primary-links',
    'weight' => 1,
  );
  //
  //$items['hosting/projects/platform/create/%'] = array(
  //  'title' => 'Create and add a platform',
  //  'description' => 'Create and add a platform to an existing project',
  //  'page callback' => 'drupal_get_form',
  //  'page arguments' => array('devshop_projects_platform_create_form', 4),
  //  'access arguments' => array('view projects'),
  //);
  //
  //$items['hosting/projects/delete/%'] = array(
  //  'title' => t('Delete Project'),
  //  'description' => 'Delete a project and all of it\'s associated sites and platforms', 
  //  'page callback' => 'drupal_get_form',
  //  'page arguments' => array('devshop_projects_project_delete_form', 3),
  //  'access arguments' => array('delete project'),
  //);
  return ($items);
}

/**
 * Implementation of hook_menu_alter()
 *
 * Replaces node/add/project with a ctools wizard.
 */
function devshop_projects_menu_alter(&$items) {
  $items['node/add/project']['page callback'] = 'devshop_projects_create_wizard';
  $items['node/add/project']['page arguments'] = array(3);
  $items['node/add/project']['file'] = 'create-wizard.inc';
  $items['node/add/project']['file path'] = drupal_get_path('module', 'devshop_projects') . '/inc';
}

/**
 * Status display
 *
 * @TODO: All of it!
 */
function devshop_projects_project_status(){
  
  if ($create_task_exists) {
    $msg = t('Git Cloning...');
  } elseif ($platforms_exist) {
    $msg = t('Verifying Platforms...');
  } elseif ($platforms_verified) {
    $msg = t('Platforms Verified!');
    $msg .= drupal_get_form('devshop_projects_project_site_install');
  } else {
    $msg = t('@TODO');
  }
  
  return $msg;
}

/**
 * Implements hook_hosting_drush_aliases_name()
 *
 * See http://drupal.org/project/hosting_drush_aliases
 */
function devshop_projects_hosting_drush_aliases_name($node) {
  if (isset($node->project_name)){
    return $node->project_name .".". $node->project_environment;
  }
}
//
///*
// * Helper function to create a site in a project
// */
//function devshop_projects_create_site($project_node, $platform_node, $env) {
//
//  global $user;
//    
//  // Create the site nodes
//  $node = new stdClass();
//  $node->type = 'site';
//  $node->status = 1;
//  $node->uid = $user->uid;
//  $node->title = $env .'.'. $project_node->base_url;
//
//  // Aegir properties
//  // @TODO: better client support
//  $node->client = HOSTING_DEFAULT_CLIENT;  
//  $node->db_server = db_result(db_query('SELECT nid FROM {hosting_db_server}'));
//    
//  $node->platform = $platform_node->nid;
//  $node->profile = db_result(db_query('SELECT nid FROM {hosting_package} WHERE short_name = "%s"', $project_node->install_profile));
//    
//  //$node->port  = db_result(db_query("SELECT ports FROM {hosting_platform} p WHERE p.nid = %d", $nid));
//    
//  // @TODO: Improve site language handling?
//  $node->site_language = !empty($user->language)? $user->language: 'en';
//
//  // Save the node
//  if ($node = node_submit($node)) {
//    node_save($node);
//      
//    //And save the association to the project
//    db_query('INSERT INTO {hosting_devshop_project_object} (project_nid, object_nid, object_type, env_type) VALUES (%d, %d, "%s", "%s")', $project_node->nid, $node->nid, $node->type, $env);
//  }
//}

///**
// * Helper function which writes a serialize array in the project file
// */
//function devshop_projects_project_data_set($nid, $data) {
//  db_query("UPDATE {hosting_devshop_project} SET data = '%s' WHERE nid = %d",
//	   serialize($data), $nid);
//}
//
///**
// * Helper function which reads the serialize array in the project file
// */
//function devshop_projects_project_data_get($nid) {
//
//  $sdata = db_result(db_query("SELECT data FROM {hosting_devshop_project} " .
//			     "WHERE nid = %d", $nid));
//
//  if (!$sdata || strlen($sdata) < 1) {
//    $data = array();
//  }
//  else {
//    $data = unserialize($sdata);
//  }
//
//  return $data;
//}



