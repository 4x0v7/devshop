#!/usr/bin/env bash
DEVSHOP_PATH="$( cd "$(dirname "$0")"/.. ; pwd -P )"
PATH="$DEVSHOP_PATH/bin:$PATH"

set -e

devshop-logo "Docker Entrypoint"

# Set ANSIBLE_TAGS from environment variable ANSIBLE_TAGS, or use ANSIBLE_TAGS_RUNTIME.
ANSIBLE_TAGS=${ANSIBLE_TAGS:-runtime}
DOCKER_COMMAND=${@:-devshop-ansible-playbook}
DOCKER_COMMAND_POST=${DOCKER_COMMAND_POST:-"echo 'Docker command $DOCKER_COMMAND complete!'"}
INIT_COMMAND=${INIT_COMMAND:-docker-systemd}

DEBUG_ENVIRONMENT=${DEBUG_ENVIRONMENT:-ANSIBLE_}

if [ -n "${DEVSHOP_ENTRYPOINT_LOG_FILES}" ]; then
  DOCKER_COMMAND_LOGS="tail-file --follow --verbose $DEVSHOP_ENTRYPOINT_LOG_FILES"
  echo "Tailing Log Files: $DEVSHOP_ENTRYPOINT_LOG_FILES"
  echo 'TIP: Set the $DEVSHOP_ENTRYPOINT_LOG_FILES environment variable to change the files to show in the Docker logs.'
  devshop-line
else
  echo 'WARNING: $DEVSHOP_ENTRYPOINT_LOG_FILES variable was empty. Not showing any log files.'
  devshop-line
fi

echo "The following commands will be run in this container: "
echo "INIT_COMMAND:        $INIT_COMMAND"
echo "DOCKER_COMMAND:      $DOCKER_COMMAND"
echo "DOCKER_COMMAND_POST: $DOCKER_COMMAND_POST"
echo "DOCKER_COMMAND_LOGS: $DOCKER_COMMAND_LOGS"
devshop-line
echo "Container Environment:"
env | grep "${DEBUG_ENVIRONMENT}" || echo "No Variables with a name containing '${DEBUG_ENVIRONMENT}' found."
echo 'TIP: Set the $DEBUG_ENVIRONMENT environment variable to a variable name (or partial string) to print out values.'
devshop-line

log "Launching Docker Commands in a new process..."
((sleep 3 && \
  devshop-logo "Running DOCKER_COMMAND: $DOCKER_COMMAND ..." && $DOCKER_COMMAND &&
  devshop-logo "Running DOCKER_COMMAND_POST: $DOCKER_COMMAND_POST ..." && $DOCKER_COMMAND_POST && \
  devshop-logo "Running DOCKER_COMMAND_LOGS: $DOCKER_COMMAND_LOGS ..." && $DOCKER_COMMAND_LOGS \
) || (echo "Command failed!" && exit 1)) &

DOCKER_COMMANDS_PID=$!

echo "Docker Commands PID: $DOCKER_COMMAND_PID"

devshop-line

# We keep this as devshop-systemd because systemd must run as PID 1.
log "Running Init Command: $INIT_COMMAND"
exec "$INIT_COMMAND"
