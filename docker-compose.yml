# DevShop Development Dockerfile
version: '3'
services:

  devshop:
    image: "devshop/server:${OS:-ubuntu1804}"
    ports:
      - "80:80"
      - "2222:22"
    hostname: devshop.local.computer
    extra_hosts:
      - "drpl8.testenv.devshop.local.computer:127.0.0.1"
    command: echo 'Hello World! DevShop Development Image here. To run as a single process, override 'command' in docker-compose.yml. '
    environment:
      DEVSHOP_TEST: x
      # By default, devshop container will run 'ansible-playbook --tags' runtime after running the "command"
      # Change the DEVSHOP_DOCKER_COMMAND_RUN if you want to manually run commands instead.
      # DEVSHOP_DOCKER_COMMAND_RUN: ansible-playbook /etc/ansible/play.yml --tags runtime --extra-vars @/etc/ansible/vars.yml
      ANSIBLE_VERBOSITY: 1

    privileged: true
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
      - /var/lib/mysql
      - /var/logs/aegir

      # @TODO: In docker/ansible branch, these are here. In composer devmaster branch, these are in docker-compose.volumes.yml.
      - ./aegir-home:/var/aegir:delegated
      - ./devmaster:/usr/share/devshop/src/DevShop/Templates/DevShopControlTemplate/web/profiles/devmaster
      - ./provision:/var/aegir/.drush/commands/provision:delegated
      - ./:/usr/share/devshop:delegated
      - ./roles/devshop.server/play.yml:/etc/ansible/play.yml
      - ./vars.yml:/etc/ansible/vars.yml
      - ./roles:/etc/ansible/roles
      - $HOME/.ssh:/var/aegir/.ssh
      # To develop the docker-systemd-entrypoint without having to rebuild the container, set this volume.
      - ./docker/bin/docker-systemd-entrypoint:/usr/local/bin/docker-systemd-entrypoint

    # Resource allocation.
    # 4GB, 2CPUs is a good minimum.

    # mem_limit is a hard upper limit for the container.
    # If using linux, make sure this is below your system's idle free memory or your desktop will slow down.
    mem_limit: 10g

    # mem_reservation is a minimum that your system will reserve for the container.
    # DevShop needs about 4GB to provide a good user experience.
    mem_reservation: 4g

    # Restrict the containers to only use the first 2 CPUs
    cpuset: 0,1
